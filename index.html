<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IsaacsPOS — Customer Portal</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: Segoe UI, Arial, sans-serif;
      color: #1f2d3d;
      height: 100vh;
      background: linear-gradient(-45deg, #a8edea, #fed6e3, #d4fc79, #96e6a1);
      background-size: 400% 400%;
      animation: gradientBG 20s ease infinite;
    }
    @keyframes gradientBG {
      0% {background-position: 0% 50%;}
      50% {background-position: 100% 50%;}
      100% {background-position: 0% 50%;}
    }
    .card {
      border-radius: 16px;
      box-shadow: 0 10px 28px rgba(0,0,0,.12);
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(10px);
    }
    .small-muted { font-size:.9rem; color:#6c757d }
    h3, h5 { color:#174f33; }
    .btn-success { background:#28a745; border:none; }
    .btn-primary { background:#0077cc; border:none; }
  </style>
</head>
<body>
<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-md-7">
      <div class="card p-4">
        <h3 class="mb-3">Welcome — Customer Portal</h3>
        <p class="small-muted">Choose the company you're visiting, sign up or log in using phone + password.</p>

        <!-- Company selector -->
        <div class="mb-3">
          <label class="form-label">Select company</label>
          <select id="companySelect" class="form-select"></select>
        </div>

        <hr />

        <!-- Signup -->
        <h5>Sign up</h5>
        <div id="signupAlert" class="alert d-none"></div>
        <div class="row g-2 mb-3">
          <div class="col-md-6"><input id="signupName" class="form-control" placeholder="First name"></div>
          <div class="col-md-6"><input id="signupSurname" class="form-control" placeholder="Surname"></div>
          <div class="col-md-6"><input id="signupPhone" class="form-control" placeholder="Phone (include country code, e.g. +27...)"></div>
          <div class="col-md-6"><input id="signupPassword" class="form-control" type="password" placeholder="Password"></div>
        </div>
        <div class="mb-3">
          <button id="btnSignup" class="btn btn-success">Sign up</button>
          <span class="small-muted ms-2">You'll receive your PIN/password via WhatsApp (Admin sends this).</span>
        </div>

        <hr />

        <!-- Login -->
        <h5>Log in</h5>
        <div id="loginAlert" class="alert d-none"></div>
        <div class="row g-2 mb-3">
          <div class="col-md-6"><input id="loginPhone" class="form-control" placeholder="Phone"></div>
          <div class="col-md-6"><input id="loginPassword" class="form-control" type="password" placeholder="Password"></div>
        </div>
        <div class="mb-3">
          <button id="btnLogin" class="btn btn-primary">Login</button>
          <a id="cartLink" class="btn btn-outline-secondary ms-2" href="#" style="display:none">Go to Cart</a>
        </div>

        <hr />
        <p class="small-muted">If your company isn't listed, please contact the business so the Admin can register it.</p>
      </div>
    </div>
  </div>
</div>

<script>
const RAW_BASE = 'https://raw.githubusercontent.com/maliq273/IsaacsPOS/main';
const ADMIN_BASE = location.origin; // assumes admin backend is same host

async function sha256hex(message) {
  const msg = new TextEncoder().encode(message);
  const digest = await crypto.subtle.digest('SHA-256', msg);
  return Array.from(new Uint8Array(digest)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

/* Load companies */
async function loadClients() {
  const sel = document.getElementById('companySelect');
  sel.innerHTML = '<option>Loading companies...</option>';
  try {
    const r = await fetch(`${RAW_BASE}/clients.json`, {cache:'no-store'});
    if (!r.ok) throw new Error(r.statusText);
    const j = await r.json();
    sel.innerHTML = '';
    for (const c of (j.clients || [])) {
      const opt = document.createElement('option');
      opt.value = c.name;
      opt.textContent = c.name + (c.location ? ' — ' + c.location : '');
      sel.appendChild(opt);
    }
  } catch (e) {
    sel.innerHTML = '<option>Error loading companies</option>';
    console.error(e);
  }
}

/* Signup */
document.getElementById('btnSignup').addEventListener('click', async ()=>{
  const name = signupName.value.trim();
  const surname = signupSurname.value.trim();
  const phone = signupPhone.value.trim();
  const password = signupPassword.value;
  const alert = signupAlert;
  alert.classList.add('d-none');

  if (!name || !phone || !password) {
    alert.className='alert alert-danger'; alert.textContent='Name, phone and password are required.'; alert.classList.remove('d-none'); return;
  }
  const company = companySelect.value;
  const pw_hash = await sha256hex(password);

  try {
    const resp = await fetch(`${ADMIN_BASE}/api/customer_signup`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({company_name:company, name, surname, phone, password_hash:pw_hash})
    });
    const data = await resp.json();
    if (resp.ok && data.ok) {
      alert.className='alert alert-success'; alert.textContent='Signup successful — you will receive instructions via WhatsApp shortly.'; alert.classList.remove('d-none');
      cartLink.style.display='inline-block';
      cartLink.href=`cart.html?company=${encodeURIComponent(company)}&phone=${encodeURIComponent(phone)}`;
    } else {
      alert.className='alert alert-danger'; alert.textContent=(data && data.error)?data.error:'Signup failed.'; alert.classList.remove('d-none');
    }
  } catch(e) {
    alert.className='alert alert-danger'; alert.textContent='Network error signing up.'; alert.classList.remove('d-none'); console.error(e);
  }
});

/* Login */
document.getElementById('btnLogin').addEventListener('click', async ()=>{
  const phone = loginPhone.value.trim();
  const password = loginPassword.value;
  const alert = loginAlert;
  alert.classList.add('d-none');
  if (!phone || !password) { alert.className='alert alert-danger'; alert.textContent='Phone and password required.'; alert.classList.remove('d-none'); return; }
  const company = companySelect.value;
  try {
    const r = await fetch(`${RAW_BASE}/customers.json`, {cache:'no-store'});
    if (!r.ok) throw new Error('Could not load customers list');
    const customers = (await r.json()).customers || [];
    const match = customers.find(c => c.company_name===company && c.phone===phone);
    if (!match) { alert.className='alert alert-danger'; alert.textContent='Customer not found for this company.'; alert.classList.remove('d-none'); return; }
    const hashed = await sha256hex(password);
    if (hashed===match.password_hash) {
      alert.className='alert alert-success'; alert.textContent='Login OK. Redirecting...'; alert.classList.remove('d-none');
      setTimeout(()=> window.location.href=`cart.html?company=${encodeURIComponent(company)}&phone=${encodeURIComponent(phone)}`, 700);
    } else { alert.className='alert alert-danger'; alert.textContent='Invalid credentials.'; alert.classList.remove('d-none'); }
  } catch(e) { console.error(e); alert.className='alert alert-danger'; alert.textContent='Network error during login.'; alert.classList.remove('d-none'); }
});

window.addEventListener('DOMContentLoaded', loadClients);
</script>
</body>
</html>








