<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IsaacsPOS — Customer Portal</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{background:#f6f9fc;font-family:Segoe UI,Arial;}
    .card{border-radius:12px;box-shadow:0 6px 22px rgba(0,0,0,.06)}
    .small-muted{font-size:.9rem;color:#6c757d}
  </style>
</head>
<body>
<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-md-7">
      <div class="card p-4">
        <h3 class="mb-3">Welcome — Customer portal</h3>
        <p class="small-muted">Choose the company you're visiting, sign up or log in using phone + password.</p>

        <!-- Company selector -->
        <div class="mb-3">
          <label class="form-label">Select company</label>
          <select id="companySelect" class="form-select"></select>
        </div>

        <hr />

        <!-- Signup -->
        <h5>Sign up</h5>
        <div id="signupAlert" class="alert d-none"></div>
        <div class="row g-2 mb-3">
          <div class="col-md-6"><input id="signupName" class="form-control" placeholder="First name"></div>
          <div class="col-md-6"><input id="signupSurname" class="form-control" placeholder="Surname"></div>
          <div class="col-md-6"><input id="signupPhone" class="form-control" placeholder="Phone (include country code, e.g. +27...)"></div>
          <div class="col-md-6"><input id="signupPassword" class="form-control" type="password" placeholder="Password"></div>
        </div>
        <div class="mb-3">
          <button id="btnSignup" class="btn btn-success">Sign up</button>
          <span class="small-muted ms-2">We'll send your PIN/password via WhatsApp (Hub handles this).</span>
        </div>

        <hr />

        <!-- Login -->
        <h5>Log in</h5>
        <div id="loginAlert" class="alert d-none"></div>
        <div class="row g-2 mb-3">
          <div class="col-md-6"><input id="loginPhone" class="form-control" placeholder="Phone"></div>
          <div class="col-md-6"><input id="loginPassword" class="form-control" type="password" placeholder="Password"></div>
        </div>
        <div class="mb-3">
          <button id="btnLogin" class="btn btn-primary">Login</button>
          <a id="cartLink" class="btn btn-outline-secondary ms-2" href="#" style="display:none">Go to Cart</a>
        </div>

        <hr />
        <p class="small-muted">If your company isn't listed, contact the business so they can register with the Hub.</p>
      </div>
    </div>
  </div>
</div>

<script>
/*
  index.html behavior:
  - Loads clients.json from the GitHub raw URL to populate company selector
  - Signup -> POST to hub endpoint /api/customer_signup (Hub must implement)
      payload: { company_name, name, surname, phone, password_hash }
      Hub should: append the customer to repo customers.json under company_name and return {ok:true, customer_id}
  - Login -> reads customers.json from GitHub raw and validates locally using SHA-256 of password (client-side)
      NOTE: reading raw GitHub is only for login convenience. Final authority should be Hub.
  - After login, the page reveals "Go to Cart" link (cart.html?company=...) passing company name and phone (URL encoded)
*/

const RAW_BASE = 'https://raw.githubusercontent.com/maliq273/IsaacsPOS/main';
const HUB_BASE = location.origin; // assumes hub runs on same host, otherwise set hub url explicitly

/* small helper: sha256 -> hex */
async function sha256hex(message) {
  const msg = new TextEncoder().encode(message);
  const digest = await crypto.subtle.digest('SHA-256', msg);
  const hex = Array.from(new Uint8Array(digest)).map(b => b.toString(16).padStart(2,'0')).join('');
  return hex;
}

/* fetch clients.json and populate select */
async function loadClients() {
  const sel = document.getElementById('companySelect');
  sel.innerHTML = '<option>Loading companies...</option>';
  try {
    const r = await fetch(`${RAW_BASE}/clients.json`, {cache:'no-store'});
    if (!r.ok) throw new Error(r.statusText);
    const j = await r.json();
    const clients = j.clients || [];
    sel.innerHTML = '';
    for (const c of clients) {
      const opt = document.createElement('option');
      opt.value = c.name;
      opt.textContent = c.name + (c.location ? ' — '+c.location : '');
      sel.appendChild(opt);
    }
  } catch (e) {
    sel.innerHTML = '<option>Error loading companies</option>';
    console.error('loadClients', e);
  }
}

/* signup */
document.getElementById('btnSignup').addEventListener('click', async () => {
  const name = document.getElementById('signupName').value.trim();
  const surname = document.getElementById('signupSurname').value.trim();
  const phone = document.getElementById('signupPhone').value.trim();
  const password = document.getElementById('signupPassword').value;

  const alert = document.getElementById('signupAlert');
  alert.classList.add('d-none');

  if (!name || !phone || !password) {
    alert.className = 'alert alert-danger';
    alert.textContent = 'Name, phone and password are required.';
    alert.classList.remove('d-none');
    return;
  }
  const company = document.getElementById('companySelect').value;

  // hash password client-side before sending
  const pw_hash = await sha256hex(password);

  const payload = {
    company_name: company,
    name, surname, phone,
    password_hash: pw_hash,
    source: 'customer_portal'
  };

  try {
    const resp = await fetch(`${HUB_BASE}/api/customer_signup`, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const data = await resp.json();
    if (resp.ok && data && data.ok) {
      alert.className = 'alert alert-success';
      alert.textContent = 'Signup successful — you will receive instructions via WhatsApp shortly.';
      alert.classList.remove('d-none');
      // optionally redirect to cart
      document.getElementById('cartLink').style.display = 'inline-block';
      document.getElementById('cartLink').href = `cart.html?company=${encodeURIComponent(company)}&phone=${encodeURIComponent(phone)}`;
    } else {
      alert.className = 'alert alert-danger';
      alert.textContent = (data && data.error) ? data.error : 'Signup failed.';
      alert.classList.remove('d-none');
    }
  } catch (e) {
    alert.className = 'alert alert-danger';
    alert.textContent = 'Network error signing up.';
    alert.classList.remove('d-none');
    console.error('signup', e);
  }
});

/* login */
document.getElementById('btnLogin').addEventListener('click', async () => {
  const phone = document.getElementById('loginPhone').value.trim();
  const password = document.getElementById('loginPassword').value;
  const alert = document.getElementById('loginAlert');
  alert.classList.add('d-none');

  if (!phone || !password) {
    alert.className = 'alert alert-danger';
    alert.textContent = 'Phone and password required.';
    alert.classList.remove('d-none');
    return;
  }

  const company = document.getElementById('companySelect').value;

  try {
    // Read customers.json from GitHub (public read)
    const r = await fetch(`${RAW_BASE}/customers.json`, {cache:'no-store'});
    if (!r.ok) throw new Error('Could not load customers list');
    const j = await r.json();
    const customers = j.customers || [];
    // find customer for this company and phone (company-name match)
    const match = customers.find(c => (c.company_name === company) && (c.phone === phone));
    if (!match) {
      alert.className = 'alert alert-danger';
      alert.textContent = 'Customer not found for this company.';
      alert.classList.remove('d-none');
      return;
    }
    // compare hashed password
    const hashed = await sha256hex(password);
    if (hashed === match.password_hash) {
      alert.className = 'alert alert-success';
      alert.textContent = 'Login OK. Redirecting to cart...';
      alert.classList.remove('d-none');
      setTimeout(()=> {
        window.location.href = `cart.html?company=${encodeURIComponent(company)}&phone=${encodeURIComponent(phone)}`;
      }, 700);
    } else {
      alert.className = 'alert alert-danger';
      alert.textContent = 'Invalid credentials.';
      alert.classList.remove('d-none');
    }
  } catch (e) {
    console.error('login', e);
    alert.className = 'alert alert-danger';
    alert.textContent = 'Network error while attempting login.';
    alert.classList.remove('d-none');
  }
});

window.addEventListener('DOMContentLoaded', loadClients);
</script>
</body>
</html>






