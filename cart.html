<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IsaacsPOS — Cart</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>body{font-family:Segoe UI,Arial;background:#f6f8fb}.card{border-radius:12px}</style>
</head>
<body>
<div class="container py-4">
  <div class="card p-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4 id="companyTitle">Company</h4>
      <div><small id="customerInfo" class="text-muted"></small></div>
    </div>

    <div class="row">
      <div class="col-md-7">
        <h6>Products</h6>
        <div id="productsList" class="list-group"></div>
      </div>
      <div class="col-md-5">
        <h6>Cart</h6>
        <ul id="cartItems" class="list-group mb-2"></ul>
        <div class="mb-2"><strong>Total: R<span id="cartTotal">0.00</span></strong></div>
        <div class="mb-3">
          <select id="paymentMethod" class="form-select mb-2">
            <option value="cash">Cash</option>
            <option value="card">Card</option>
            <option value="eft">EFT</option>
          </select>
          <button id="submitPresale" class="btn btn-success w-100">Submit Pre-sale</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/*
  cart.html:
  - Expects URL params: ?company=NAME&phone=PHONE
  - Loads inventory.json from GitHub and filters by company name
  - Allows adding items to cart and submits presale to Hub via POST /api/presale
    Payload: { machine_id (POS machine), company_name, customer_phone, customer_name, cart_json, total }
  - Hub will write presale to presales.json in the repo and return success.
*/

const RAW_BASE = 'https://raw.githubusercontent.com/maliq273/IsaacsPOS/main';
const HUB_BASE = location.origin;

function qs(name) {
  return new URLSearchParams(location.search).get(name);
}
const company = qs('company') || '';
const phone = qs('phone') || '';

document.getElementById('companyTitle').textContent = company || 'Company';
document.getElementById('customerInfo').textContent = phone ? `Customer: ${phone}` : '';

let products = [];
let cart = [];

function fmtMoney(n){ return (Number(n)||0).toFixed(2); }

async function loadInventory(){
  const container = document.getElementById('productsList');
  container.innerHTML = '<div class="small text-muted">Loading products…</div>';
  try {
    const r = await fetch(`${RAW_BASE}/inventory.json`, {cache:'no-store'});
    if(!r.ok) throw new Error('inventory fetch failed');
    const j = await r.json();
    products = (j.products || []).filter(p => p.company_name === company);
    container.innerHTML = '';
    if (!products.length) container.innerHTML = '<div class="small text-muted">No products for this company.</div>';
    for (const p of products) {
      const item = document.createElement('div');
      item.className = 'list-group-item d-flex justify-content-between align-items-start';
      item.innerHTML = `
        <div>
          <div class="fw-bold">${p.name}</div>
          <div class="small text-muted">${p.description || ''}</div>
        </div>
        <div class="text-end">
          <div>R${fmtMoney(p.price)}</div>
          <button class="btn btn-sm btn-outline-primary mt-2 addBtn">Add</button>
        </div>
      `;
      const btn = item.querySelector('.addBtn');
      btn.addEventListener('click', ()=> addToCart(p));
      container.appendChild(item);
    }
  } catch (e) {
    console.error('loadInventory', e);
    container.innerHTML = '<div class="small text-danger">Failed to load inventory.</div>';
  }
}

function addToCart(p){
  const found = cart.find(x=>x.id===p.id);
  if (found) found.qty++;
  else cart.push({ id: p.id, name: p.name, price: p.price, qty: 1 });
  renderCart();
}

function renderCart(){
  const ul = document.getElementById('cartItems');
  ul.innerHTML = '';
  let total = 0;
  for (const it of cart) {
    total += it.price * it.qty;
    const li = document.createElement('li');
    li.className = 'list-group-item d-flex justify-content-between align-items-center';
    li.innerHTML = `<div>${it.name} <small class="text-muted">x${it.qty}</small></div>
                    <div>R${fmtMoney(it.price*it.qty)}</div>`;
    ul.appendChild(li);
  }
  document.getElementById('cartTotal').textContent = fmtMoney(total);
}

document.getElementById('submitPresale').addEventListener('click', async () => {
  if (!cart.length) return alert('Add items to cart first.');
  // assemble presale payload
  const cart_json = cart.map(i=>({id:i.id, name:i.name, price:i.price, qty:i.qty}));
  const total = cart.reduce((s,i)=>s + (i.price * i.qty), 0);
  const payload = {
    machine_id: 'POS-v1',               // the POS client should set its machine id here
    company_name: company,
    customer_phone: phone || null,
    customer_name: null,
    cart_json,
    total,
    source: 'web-cart'
  };
  try {
    const r = await fetch(`${HUB_BASE}/api/presale`, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const j = await r.json();
    if (r.ok && j && j.ok) {
      alert('Presale submitted — thank you!');
      cart = []; renderCart();
    } else {
      alert('Failed to submit presale: ' + (j.error || r.statusText));
    }
  } catch (e) {
    console.error('submitPresale', e);
    alert('Network error submitting presale.');
  }
});

window.addEventListener('DOMContentLoaded', loadInventory);
</script>
</body>
</html>



