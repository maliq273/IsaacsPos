<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Cart — IsaacsPOS</title>
<style>
  :root{--accent:#66bb6a;--muted:#556;}
  body{font-family:Inter,Segoe UI,Arial; margin:0; min-height:100vh; background:#f6fbf7; color:#123; display:flex; align-items:center; justify-content:center;}
  .page { width:100%; max-width:960px; padding:20px; }
  header { display:flex; justify-content:space-between; align-items:center; margin-bottom:14px;}
  .brand { font-weight:700; color:var(--accent); font-size:1.25rem; }
  .grid { display:grid; grid-template-columns: 1fr 360px; gap:18px; align-items:start; }
  .panel { background:white; padding:16px; border-radius:12px; box-shadow:0 8px 20px rgba(10,30,10,0.06); }
  .list { display:flex; flex-direction:column; gap:8px; max-height:62vh; overflow:auto; padding-right:6px;}
  .product {display:flex; justify-content:space-between; gap:8px; align-items:center; padding:10px; border-radius:8px; border:1px solid #eef7ee;}
  .product .meta {display:flex; gap:12px; align-items:center;}
  .product .meta img{width:56px;height:56px;object-fit:cover;border-radius:8px;}
  .product button { background:var(--accent); color:white; border:none; padding:8px 10px; border-radius:8px; cursor:pointer;}
  .cart-row { display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px dashed #eee;}
  .cart-footer { margin-top:14px; text-align:right;}
  select, input[type=number] { padding:8px; border-radius:8px; border:1px solid #ddd; }
  .staff-select { width:100%; margin-bottom:10px; }
  .checkout { width:100%; padding:12px; border-radius:10px; border:none; background:var(--accent); color:white; font-weight:700; cursor:pointer;}
  small.helper{ color:#666; display:block; margin-top:6px;}
</style>
</head>
<body>
  <div class="page">
    <header>
      <div class="brand">IsaacsPOS — Customer Cart</div>
      <div id="customerBox">Loading customer…</div>
    </header>

    <div class="grid">
      <div class="panel">
        <h3>Products & Services</h3>
        <div id="productList" class="list" aria-live="polite"></div>
      </div>

      <div class="panel">
        <h3>Your Cart</h3>
        <div id="cartList"></div>
        <div class="cart-footer">
          <div style="margin-bottom:8px"><strong>Total: R<span id="total">0.00</span></strong></div>
          <div>
            <select id="staffSelect" class="staff-select"><option>Loading staff…</option></select>
            <small class="helper">Choose a staff member to serve you</small>
          </div>
          <button id="checkoutBtn" class="checkout">Checkout (create presale)</button>
          <div id="msg" style="margin-top:8px;font-weight:600;color:#2e7d32"></div>
        </div>
      </div>
    </div>
  </div>

<script>
const BACKEND_BASE = "http://YOUR_POS_BACKEND:5000"; // <<-- edit to your backend hostname
let customerPhone = null;
let inventory = [];
let staffList = [];
let cart = [];

/* get customer param */
const urlParams = new URLSearchParams(window.location.search);
customerPhone = urlParams.get('customer') || localStorage.getItem('isaacs_customer_phone') || null;
if(customerPhone) document.getElementById('customerBox').textContent = "You: " + customerPhone;
else document.getElementById('customerBox').textContent = "Guest";

/* load inventory + staff */
async function loadInventory(){
  const r = await fetch(`${BACKEND_BASE}/api/inventory`);
  if(!r.ok) { console.error('inventory'); return; }
  inventory = await r.json();
  renderProducts();
}
async function loadStaff(){
  const r = await fetch(`${BACKEND_BASE}/api/staff`);
  if(!r.ok) { console.error('staff'); return; }
  staffList = await r.json();
  const sel = document.getElementById('staffSelect');
  sel.innerHTML = staffList.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
}

/* render products */
function renderProducts(){
  const c = document.getElementById('productList'); c.innerHTML='';
  inventory.forEach(p=>{
    const el = document.createElement('div'); el.className='product';
    el.innerHTML = `<div class="meta">
      <img src="${p.image || 'https://placehold.co/56x56'}" alt="" />
      <div><strong>${p.name}</strong><div style="color:#666;font-size:13px">R${Number(p.price).toFixed(2)} ${p.type||''}</div></div>
    </div>
    <div><button data-id="${p.id}">Add</button></div>`;
    c.appendChild(el);
  });
  document.querySelectorAll('.product button').forEach(b=>{
    b.addEventListener('click', ()=> { const id = b.dataset.id; addToCart(id); });
  });
}

/* cart handling */
function addToCart(productId){
  const p = inventory.find(x=>String(x.id) === String(productId));
  if(!p){ return; }
  const line = cart.find(x=>x.product_id == p.id);
  if(line){ line.qty += 1; } else cart.push({ product_id:p.id, name:p.name, qty:1, price:Number(p.price) });
  renderCart();
}
function renderCart(){
  const el = document.getElementById('cartList'); el.innerHTML='';
  let total = 0;
  cart.forEach((ln, idx)=>{
    total += ln.qty * ln.price;
    const row = document.createElement('div'); row.className='cart-row';
    row.innerHTML = `<div>${ln.name} <span style="color:#666">x${ln.qty}</span></div>
      <div>R${(ln.qty*ln.price).toFixed(2)} <button data-i="${idx}">—</button></div>`;
    el.appendChild(row);
  });
  document.querySelectorAll('.cart-row button').forEach(b=>b.addEventListener('click', ()=>{
    const i = Number(b.dataset.i);
    cart.splice(i,1);
    renderCart();
  }));
  document.getElementById('total').textContent = total.toFixed(2);
}

/* checkout -> push presale to backend (which updates GitHub presales.json) */
document.getElementById('checkoutBtn').addEventListener('click', async ()=>{
  if(cart.length === 0) { document.getElementById('msg').textContent = 'Cart is empty.'; return; }
  const staff_id = document.getElementById('staffSelect').value;
  const payload = {
    customer_phone: customerPhone || null,
    staff_id: staff_id || null,
    items: cart,
    total: Number(document.getElementById('total').textContent)
  };
  document.getElementById('msg').textContent = 'Creating presale…';
  const r = await fetch(`${BACKEND_BASE}/api/presales`, {
    method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
  });
  const j = await r.json();
  if(r.ok && j.success){
    document.getElementById('msg').textContent = 'Presale created — the cashier will see it shortly.';
    // optionally clear cart / redirect to thankyou
    cart = []; renderCart();
  } else {
    document.getElementById('msg').textContent = j.message || 'Failed creating presale';
  }
});

/* init */
(async function init(){
  await Promise.all([loadInventory(), loadStaff()]);
  renderCart();
})();
</script>
</body>
</html>

